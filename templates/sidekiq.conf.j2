description "{{ app_name }} Sidekiq Background Worker"

# no "start on", we don't want to automatically start
start on runlevel [2345]
stop on runlevel [06]

# change to match your deployment user
setuid {{ user }}
setgid {{ user }}

respawn
respawn limit 3 30

# TERM and USR1 are sent by sidekiqctl when stopping sidekiq.  Without declaring these as normal exit codes, it just respawns.
normal exit 0 TERM USR1

# instance $index

script
# this script runs in /bin/sh by default
# respawn as bash so we can source in rbenv
exec /bin/bash <<EOT
  # use syslog for logging
  exec &> /dev/kmsg

  # pull in rbenv
  export HOME=/home/{{ user }}
  source /home/{{ user }}/.bash.d/50_rbenv.bash

  cd /home/{{ user }}/projects/{{ app_name }}/current
  exec bundle exec sidekiq -e production -C ../shared/config/sidekiq.yml
EOT
end script